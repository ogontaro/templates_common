version: '3'

dotenv: [ '.env' ]

tasks:
  default:
    desc: show commands
    cmds:
      - task -l --sort none
  init:
    desc: terraform init
    cmds:
      - AWS_PROFILE=default terraform init
    silent: true
  plan:
    desc: terraform plan
    cmds:
      - task: switch_workspace
      - terraform plan
    silent: true
  plan_debug:
    desc: terraform plan with debug
    cmds:
      - task: switch_workspace
      - TF_LOG="DEBUG" terraform plan
    silent: true
  provider:upgrade:
    desc: terraform providerのバージョンアップ
    cmds:
      - task: switch_workspace
      - terraform init -upgrade
      - task: lock:update_platform
    silent: true
  provider:add:
    desc: 新規プロバイダー情報を追加する(既存のproviderのバージョンは更新しない)
    cmds:
      - task: switch_workspace
      - terraform init
      - task: lock:update_platform
    silent: true
  _switch_workspacce:
    desc: switch terraform workspace with ENV
    internal: true
    cmds:
      - terraform workspace select ${ENV}
    silent: true
  _lock:update_platform:
    desc: terraform lock update
    internal: true
    cmds:
      - terraform providers lock -platform=windows_amd64 -platform=darwin_amd64 -platform=darwin_arm64 -platform=linux_amd64 -platform=linux_arm64
    silent: true
