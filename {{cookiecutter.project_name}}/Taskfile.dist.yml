version: '3'

dotenv: [ '.env' ]

tasks:
  default:
    desc: show commands
    cmds:
      - task -l --sort none
  dump:
    desc: helmfile dump template
    cmds:
      - task: _set-context
      - rm -rf dump.yaml
      - helmfile --environment sandbox template > dump.yaml
    silent: true
  apply:
    desc: helmfile apply
    cmds:
      - task: _set-context
      - helmfile --environment sandbox apply
    silent: true
  sync:
    desc: helmfile sync
    cmds:
      - task: _set-context
      - helmfile --environment sandbox sync
    silent: true
  lint:
    desc: helmfile lint
    cmds:
      - task: _set-context
      - helmfile --environment sandbox template | kube-score score -
    silent: true
  delete:
    desc: helmfile delete
    cmds:
      - task: _set-context
      - helmfile --environment sandbox delete
    silent: true
  _set-context:
    internal: true
    desc: set kubectl sandbox context
    cmds:
      - kubectl config use-context ogontaro_sandbox
    silent: true
  cruft:update:
    desc: update cruft project
    cmds:
      - cruft update --skip-apply-ask --refresh-private-variables
    silent: true
